<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salon Pro — Facturación & Citas</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0f12">
<style>
/* =========================
   THEME / DISEÑO ELEGANTE
   ========================= */
:root{
  /* Colores base (100% editables en Configuración) */
  --bg:#0f0f12;
  --fg:#ffffff;
  --muted:#a7a7b1;
  --primary:#6ee7b7;
  --primary-2:#22c55e;
  --accent:#93c5fd;
  --danger:#ef4444;
  --warn:#f59e0b;
  --card:#171821;
  --card-2:#1e202b;
  --topbar:#11121a;
  --footer:#0c0d12;
  --btn:#24263a;
  --outline:#2a2d40;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:18px;
  --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, "Helvetica Neue", Arial;
  --bg-opacity:1; /* 1 = sólido, 0.75 = traslúcido */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background: rgba(15,15,18,var(--bg-opacity));
  color:var(--fg); font-family:var(--font); -webkit-font-smoothing:antialiased;
  background-image: var(--bg-image, none);
  background-size: cover; background-position:center; background-attachment:fixed;
}
a{color:inherit; text-decoration:none}
button{cursor:pointer; border:0; background:var(--btn); color:#fff; border-radius:12px; padding:.8rem 1rem; box-shadow:var(--shadow); transition:transform .18s ease, opacity .18s ease}
button:hover{transform:translateY(-1px)}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b91c1c)}
.btn-warn{background:linear-gradient(135deg,var(--warn),#f59e0b)}
.btn-ghost{background:transparent; border:1px solid var(--outline)}
.input, select, textarea{
  width:100%; padding:.78rem .9rem; background:#11131a; color:#fff; border:1px solid var(--outline);
  border-radius:12px; outline:none; transition:border-color .15s ease, box-shadow .15s ease
}
.input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(147,197,253,.25)}
label{display:block; font-size:.9rem; color:var(--muted); margin:.1rem 0 .35rem}
.card{
  background: linear-gradient(180deg, var(--card), var(--card-2));
  border:1px solid var(--outline);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:1.1rem;
}
.row{display:grid; gap:1rem}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:repeat(3,1fr)}
.row.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:980px){
  .row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}
}
.table{width:100%; border-collapse:separate; border-spacing:0 10px}
.table th, .table td{padding:.75rem .9rem; text-align:left}
.table thead th{color:#cdd4ff; font-weight:600; font-size:.9rem}
.tr{
  background: linear-gradient(180deg,#141726,#0f1220);
  border:1px solid var(--outline);
  border-radius:12px;
}
.tr td:first-child,.tr th:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
.tr td:last-child,.tr th:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
.badge{display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; background:#101323; border:1px solid var(--outline); border-radius:999px; font-size:.78rem; color:#c7d2fe}
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:1rem}
.kpi{padding:1rem; border-radius:16px; background:#10121a; border:1px solid var(--outline)}
.kpi .label{color:#b5bad6; font-size:.85rem}
.kpi .value{font-size:1.4rem; font-weight:700}
.topbar{
  position:sticky; top:0; z-index:50;
  background: linear-gradient(180deg,var(--topbar), rgba(17,18,26,.85));
  backdrop-filter: blur(8px);
  border-bottom:1px solid var(--outline);
}
.topbar-inner{display:flex; align-items:center; gap:1rem; padding:.8rem 1rem}
.brand{display:flex; align-items:center; gap:.7rem}
.brand img{width:36px; height:36px; border-radius:10px; object-fit:cover; border:1px solid var(--outline)}
.brand .title{font-weight:800; letter-spacing:.2px}
.top-actions{margin-left:auto; display:flex; gap:.5rem; align-items:center}
.top-actions .avatar{width:34px; height:34px; border-radius:50%; background:#0f1118; border:1px solid var(--outline)}
.container{max-width:1160px; margin:1.2rem auto; padding:0 1rem 4rem}
.footer{
  margin-top:3rem; padding:1.2rem; text-align:center; color:#9aa3c7;
  border-top:1px solid var(--outline); background:var(--footer)
}
.screen{display:none}
.screen.active{display:block; animation:fade .18s ease}
@keyframes fade{from{opacity:.5; transform:translateY(2px)} to{opacity:1; transform:none}}
.menu-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:1rem}
.menu-card{display:flex; flex-direction:column; gap:.75rem; padding:1.1rem; border-radius:18px; border:1px solid var(--outline); background:linear-gradient(180deg,#121422,#0d1020)}
.menu-card h3{margin:0; font-size:1.05rem}
.menu-card p{margin:0; color:#aeb6d9; font-size:.9rem}
.menu-card .actions{display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap}
.backline{display:flex; align-items:center; gap:.7rem; margin-bottom:1rem}
.backline button{padding:.6rem .8rem}
.small{font-size:.85rem}
.right{margin-left:auto}
.help{color:#a9b2dc; font-size:.85rem}
.login-wrap{max-width:440px; margin:6vh auto}
.logo-preview{width:56px; height:56px; border-radius:12px; object-fit:cover; border:1px solid var(--outline); background:#0e1020}
.center{text-align:center}
hr.sep{border:0; height:1px; background:linear-gradient(90deg, transparent, #28304a, transparent); margin:1rem 0}
.chips{display:flex; gap:.5rem; flex-wrap:wrap}
.chip{padding:.35rem .6rem; border-radius:999px; border:1px solid var(--outline); background:#0c0f1e; color:#c7cff7; font-size:.78rem}
.preview{width:100%; max-height:220px; object-fit:contain; background:#0b0e1a; border:1px dashed var(--outline); border-radius:12px; padding:.6rem}
.toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
.spacer{flex:1}
.hidden{display:none !important}
@media print{
  body{background:white !important; color:black !important}
  .topbar, .footer, .no-print{display:none !important}
  .card, .tr{box-shadow:none; border:1px solid #ddd}
}
</style>
</head>
<body>
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img id="brandLogo" alt="logo">
      <div>
        <div class="title" id="brandName">Salon Pro</div>
        <div class="small" id="brandSub">Agenda & Facturación</div>
      </div>
    </div>
    <div class="top-actions no-print">
      <button id="btnHome" class="btn-ghost" title="Menú">Menú</button>
      <button id="btnConfig" class="btn-ghost" title="Configuración">Config</button>
      <button id="btnLogout" class="btn-danger" title="Salir">Salir</button>
      <div class="avatar" title="Usuario" id="whoami"></div>
    </div>
  </div>
</header>

<main class="container">
  <!-- LOGIN -->
  <section id="screen-login" class="screen active">
    <div class="login-wrap">
      <div class="center">
        <img id="loginLogo" class="logo-preview" alt="Logo">
        <h1 style="margin:.6rem 0 0">Bienvenido</h1>
        <p class="help">Inicia sesión para continuar</p>
      </div>
      <div class="card" style="margin-top:1rem">
        <div class="row cols-2">
          <div>
            <label>Usuario</label>
            <input id="loginUser" class="input" placeholder="admin o usuario">
          </div>
          <div>
            <label>Contraseña</label>
            <input id="loginPass" type="password" class="input" placeholder="••••••••">
          </div>
        </div>
        <div class="row" style="margin-top:.8rem">
          <button id="doLogin" class="btn-primary">Entrar</button>
          <div class="chips">
            <span class="chip">admin / admin123 (admin)</span>
            <span class="chip">usuario / user123 (usuario)</span>
          </div>
        </div>
      </div>
      <hr class="sep">
      <div class="card">
        <b>Notas</b>
        <p class="help">El rol <b>admin</b> ve todo; el <b>usuario</b> solo Agenda y Facturación.</p>
      </div>
    </div>
  </section>

  <!-- INICIO / MENÚ -->
  <section id="screen-home" class="screen">
    <div class="row">
      <div class="backline no-print">
        <h2 style="margin:0">Menú principal</h2>
        <span class="spacer"></span>
        <span class="help">Selecciona una sección</span>
      </div>
      <div class="menu-grid">
        <div class="menu-card">
          <h3>Agenda de citas</h3>
          <p>Crear, listar, evitar duplicados, “no show”, WhatsApp y Google.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-agenda">Abrir Agenda</button></div>
        </div>
        <div class="menu-card">
          <h3>Facturación</h3>
          <p>Genera facturas y envíalas por WhatsApp. Exporta PDF/CSV.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-facturacion">Abrir Facturación</button></div>
        </div>
        <div class="menu-card">
          <h3>Panel Administrativo</h3>
          <p>Confirmación 24h (WhatsApp), Propinas por técnica y Exportaciones.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-export">Abrir Panel</button></div>
        </div>
        <div class="menu-card">
          <h3>Análisis de rendimiento</h3>
          <p>KPIs y gráfica 30 días.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-analytics">Ver Análisis</button></div>
        </div>
        <div class="menu-card">
          <h3>Empleados</h3>
          <p>Añade / edita empleados para agenda y facturas.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-empleados">Gestionar</button></div>
        </div>
        <div class="menu-card">
          <h3>Configuración</h3>
          <p>Colores, logo, fondo, Google, ATH Móvil, exportar/importar.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-config">Abrir Config</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="screen-agenda" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">← Regresar</button>
      <h2 style="margin:0">Agenda de Citas</h2>
      <span class="spacer"></span>
      <button id="btnAgendaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div><label>Cliente</label><input id="a_nombre" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Teléfono</label><input id="a_tel" class="input" placeholder="+1 787 000 0000"></div>
        <div><label>Empleado/Técnica</label><select id="a_emp" class="input"></select></div>
        <div><label>Servicio</label><input id="a_srv" class="input" placeholder="Corte, color, etc."></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="a_fecha" type="date" class="input"></div>
        <div><label>Hora</label><input id="a_hora" type="time" class="input" step="900"></div>
        <div><label>Duración (min)</label><input id="a_dur" type="number" class="input" value="60" min="15" step="15"></div>
        <div><label>Notas</label><input id="a_notas" class="input" placeholder="Observaciones"></div>
      </div>
      <div class="toolbar" style="margin-top:.7rem">
        <button id="btnAgendaGuardar" class="btn-primary">Guardar cita</button>
        <button id="btnAgendaNoShow" class="btn-warn">Marcar No Show</button>
        <div class="spacer"></div>
        <button id="btnAgendaGoogle" class="btn-ghost">Enviar a Google Form</button>
        <button id="btnAgendaGoogleTest" class="btn-ghost">Probar envío (abrir)</button>
        <button id="btnAgendaWhatsApp" class="btn-ghost">WhatsApp confirmación</button>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Listado de citas</b>
          <div class="spacer"></div>
          <label class="small">Filtrar por fecha</label>
          <input id="f_fecha" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="f_emp" class="input" style="width:auto"></select>
          <button id="btnAgendaFiltrar" class="btn-ghost">Aplicar</button>
        </div>
        <table class="table" id="tblCitas">
          <thead><tr class="tr">
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Empleado</th><th>Servicio</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FACTURACIÓN -->
  <section id="screen-facturacion" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">← Regresar</button>
      <h2 style="margin:0">Facturación</h2>
      <span class="spacer"></span>
      <button id="btnFacturaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div><label># Factura</label><input id="f_num" class="input" placeholder="AUTOMÁTICO" disabled></div>
        <div><label>Cliente</label><input id="f_cli" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Teléfono</label><input id="f_tel" class="input" placeholder="+1 787 ..."></div>
        <div><label>Empleado</label><select id="ff_emp" class="input"></select></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="f_fecha" type="date" class="input"></div>
        <div><label>Método de pago</label>
          <select id="f_pago" class="input"><option>ATH Móvil</option><option>Tarjeta</option><option>Cash</option></select>
        </div>
        <!-- 👇 IVU por defecto 0 -->
        <div><label>IVU %</label><input id="f_ivu" type="number" class="input" value="0" step=".1" min="0"></div>
        <div><label>Propinas</label><input id="f_propina" type="number" step=".01" min="0" class="input" placeholder="0.00" value="0"></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <div class="toolbar">
          <b>Conceptos</b>
          <div class="spacer"></div>
          <button id="btnAddLinea" class="btn-ghost">Añadir línea</button>
          <button id="btnLoadServicios" class="btn-ghost">Servicios guardados</button>
        </div>
        <div id="lineas"></div>
        <hr class="sep">
        <div class="row cols-3">
          <div class="card">
            <div class="row cols-2">
              <div><label>Subtotal</label><input id="f_sub" class="input" disabled></div>
              <div><label>IVU</label><input id="f_tax" class="input" disabled></div>
            </div>
            <div class="row" style="margin-top:.6rem">
              <label>Total</label><input id="f_total" class="input" disabled>
            </div>
          </div>
          <div class="card">
            <b>ATH Móvil / QR</b>
            <div class="row">
              <input id="ath_alias" class="input" placeholder="Alias o Número de ATH Móvil">
              <input id="ath_monto" class="input" placeholder="Monto a cobrar (auto)" disabled>
              <label class="small">Sube tu código QR</label>
              <input id="ath_qr" type="file" accept="image/*" class="input">
              <img id="ath_preview" class="preview" alt="QR ATH Móvil">
            </div>
          </div>
          <div class="card">
            <b>Acciones</b>
            <div class="row">
              <button id="btnFacturaGuardar" class="btn-primary">Guardar Factura</button>
              <button id="btnFacturaWhatsApp" class="btn-ghost">Enviar por WhatsApp</button>
              <button id="btnFacturaExportPDF" class="btn-ghost">Exportar PDF (Imprimir)</button>
              <button id="btnFacturaExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- INICIO / MENÚ -->
  <section id="screen-home" class="screen">
    <div class="row">
      <div class="backline no-print">
        <h2 style="margin:0">Menú principal</h2>
        <span class="spacer"></span>
        <span class="help">Selecciona una sección</span>
      </div>
      <div class="menu-grid">
        <div class="menu-card">
          <h3>Agenda de citas</h3>
          <p>Crear, listar, evitar duplicados, “no show”, WhatsApp y Google.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-agenda">Abrir Agenda</button></div>
        </div>
        <div class="menu-card">
          <h3>Facturación</h3>
          <p>Genera facturas y envíalas por WhatsApp. Exporta PDF/CSV.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-facturacion">Abrir Facturación</button></div>
        </div>
        <div class="menu-card">
          <h3>Panel Administrativo</h3>
          <p>Confirmación 24h (WhatsApp), Propinas por técnica y Exportaciones.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-export">Abrir Panel</button></div>
        </div>
        <div class="menu-card">
          <h3>Análisis de rendimiento</h3>
          <p>KPIs y gráfica 30 días.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-analytics">Ver Análisis</button></div>
        </div>
        <div class="menu-card">
          <h3>Empleados</h3>
          <p>Añade / edita empleados para agenda y facturas.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-empleados">Gestionar</button></div>
        </div>
        <div class="menu-card">
          <h3>Configuración</h3>
          <p>Colores, logo, fondo, Google, ATH Móvil, exportar/importar.</p>
          <div class="actions"><button class="btn-primary" data-goto="screen-config">Abrir Config</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="screen-agenda" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">← Regresar</button>
      <h2 style="margin:0">Agenda de Citas</h2>
      <span class="spacer"></span>
      <button id="btnAgendaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div><label>Cliente</label><input id="a_nombre" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Teléfono</label><input id="a_tel" class="input" placeholder="+1 787 000 0000"></div>
        <div><label>Empleado/Técnica</label><select id="a_emp" class="input"></select></div>
        <div><label>Servicio</label><input id="a_srv" class="input" placeholder="Corte, color, etc."></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="a_fecha" type="date" class="input"></div>
        <div><label>Hora</label><input id="a_hora" type="time" class="input" step="900"></div>
        <div><label>Duración (min)</label><input id="a_dur" type="number" class="input" value="60" min="15" step="15"></div>
        <div><label>Notas</label><input id="a_notas" class="input" placeholder="Observaciones"></div>
      </div>
      <div class="toolbar" style="margin-top:.7rem">
        <button id="btnAgendaGuardar" class="btn-primary">Guardar cita</button>
        <button id="btnAgendaNoShow" class="btn-warn">Marcar No Show</button>
        <div class="spacer"></div>
        <button id="btnAgendaGoogle" class="btn-ghost">Enviar a Google Form</button>
        <button id="btnAgendaGoogleTest" class="btn-ghost">Probar envío (abrir)</button>
        <button id="btnAgendaWhatsApp" class="btn-ghost">WhatsApp confirmación</button>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Listado de citas</b>
          <div class="spacer"></div>
          <label class="small">Filtrar por fecha</label>
          <input id="f_fecha" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="f_emp" class="input" style="width:auto"></select>
          <button id="btnAgendaFiltrar" class="btn-ghost">Aplicar</button>
        </div>
        <table class="table" id="tblCitas">
          <thead><tr class="tr">
            <th>Fecha</th><th>Hora</th><th>Cliente</th><th>Empleado</th><th>Servicio</th><th>Tel</th><th>Estado</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FACTURACIÓN -->
  <section id="screen-facturacion" class="screen">
    <div class="backline">
      <button class="btn-ghost" data-goto="screen-home">← Regresar</button>
      <h2 style="margin:0">Facturación</h2>
      <span class="spacer"></span>
      <button id="btnFacturaImprimir" class="btn-ghost no-print">Imprimir</button>
    </div>

    <div class="card">
      <div class="row cols-4">
        <div><label># Factura</label><input id="f_num" class="input" placeholder="AUTOMÁTICO" disabled></div>
        <div><label>Cliente</label><input id="f_cli" class="input" placeholder="Nombre y apellidos"></div>
        <div><label>Teléfono</label><input id="f_tel" class="input" placeholder="+1 787 ..."></div>
        <div><label>Empleado</label><select id="ff_emp" class="input"></select></div>
      </div>
      <div class="row cols-4" style="margin-top:.6rem">
        <div><label>Fecha</label><input id="f_fecha" type="date" class="input"></div>
        <div><label>Método de pago</label>
          <select id="f_pago" class="input"><option>ATH Móvil</option><option>Tarjeta</option><option>Cash</option></select>
        </div>
        <!-- ✅ IVU en 0 por defecto, según tu pedido -->
        <div><label>IVU %</label><input id="f_ivu" type="number" class="input" value="0" step=".1" min="0"></div>
        <div><label>Propinas</label><input id="f_propina" type="number" step=".01" min="0" class="input" placeholder="0.00" value="0"></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <div class="toolbar">
          <b>Conceptos</b>
          <div class="spacer"></div>
          <button id="btnAddLinea" class="btn-ghost">Añadir línea</button>
          <button id="btnLoadServicios" class="btn-ghost">Servicios guardados</button>
        </div>
        <div id="lineas"></div>
        <hr class="sep">
        <div class="row cols-3">
          <div class="card">
            <div class="row cols-2">
              <div><label>Subtotal</label><input id="f_sub" class="input" disabled></div>
              <div><label>IVU</label><input id="f_tax" class="input" disabled></div>
            </div>
            <div class="row" style="margin-top:.6rem">
              <label>Total</label><input id="f_total" class="input" disabled>
            </div>
          </div>
          <div class="card">
            <b>ATH Móvil / QR</b>
            <div class="row">
              <input id="ath_alias" class="input" placeholder="Alias o Número de ATH Móvil">
              <input id="ath_monto" class="input" placeholder="Monto a cobrar (auto)" disabled>
              <label class="small">Sube tu código QR</label>
              <input id="ath_qr" type="file" accept="image/*" class="input">
              <img id="ath_preview" class="preview" alt="QR ATH Móvil">
            </div>
          </div>
          <div class="card">
            <b>Acciones</b>
            <div class="row">
              <button id="btnFacturaGuardar" class="btn-primary">Guardar Factura</button>
              <button id="btnFacturaWhatsApp" class="btn-ghost">Enviar por WhatsApp</button>
              <button id="btnFacturaExportPDF" class="btn-ghost">Exportar PDF (Imprimir)</button>
              <button id="btnFacturaExportCSV" class="btn-ghost">Exportar Excel (CSV)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:1rem">
      <div class="card">
        <div class="toolbar">
          <b>Historial de facturas</b>
          <div class="spacer"></div>
          <label class="small">Rango</label>
          <input id="h_desde" type="date" class="input" style="width:auto">
          <input id="h_hasta" type="date" class="input" style="width:auto">
          <label class="small">Empleado</label>
          <select id="h_emp" class="input" style="width:auto"></select>
          <button id="btnHistFiltrar" class="btn-ghost">Filtrar</button>
        </div>
        <table class="table" id="tblFacturas">
          <thead><tr class="tr">
            <th>#</th><th>Fecha</th><th>Cliente</th><th>Empleado</th><th>Método</th><th>Total</th><th class="no-print">Acciones</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- AGENDA (no duplicar, no show, WhatsApp, Google Form) -->
  <script>
  /* ============================================================
    AGENDA (no duplicar, no show, WhatsApp, Google Form)
    ============================================================= */
  function citaKey(c){ return [c.fecha,c.hora,c.emp,(c.tel||'').replace(/\D/g,'')].join('|').toLowerCase(); }
  function citaDuplicada(cita, citas){
    return citas.some(x=>citaKey(x)===citaKey(cita));
  }
  function nowTimeHHMM(){
    const d=new Date();
    const hh=String(d.getHours()).padStart(2,'0');
    const mm=String(d.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }
  function citaGuardar(){
    const nombre=byId('a_nombre').value.trim();
    const tel=byId('a_tel').value.trim();
    const emp=byId('a_emp').value;
    const srv=byId('a_srv').value.trim();

    // ✅ Fecha y hora siempre se actualizan al momento de guardar
    const fecha=todayISO();
    const hora=nowTimeHHMM();

    const dur=+byId('a_dur').value||60;
    const notas=byId('a_notas').value.trim();
    if(!nombre || !tel || !emp) return alert('Completa nombre, teléfono y empleado.');

    // Sincroniza los inputs para que el usuario vea lo que se guardó
    if(byId('a_fecha')) byId('a_fecha').value = fecha;
    if(byId('a_hora'))  byId('a_hora').value  = hora;

    let citas=load(K.CITAS,[]);
    const cita={id:uuid(), nombre,tel,emp,srv,fecha,hora,dur,notas, estado:'programada'};
    if(citaDuplicada(cita,citas)) return alert('Duplicado: ya existe cita con esa persona a esa hora.');
    citas.push(cita); save(K.CITAS,citas);
    renderCitas(); alert('Cita guardada.');
  }
  function citaNoShow(){
    const nombre=byId('a_nombre').value.trim();
    const tel=byId('a_tel').value.trim();
    const fecha=byId('a_fecha').value;
    const hora=byId('a_hora').value;
    let citas=load(K.CITAS,[]);
    citas=citas.map(c=>{
      if(c.nombre===nombre && c.tel===tel && c.fecha===fecha && c.hora===hora){ return {...c, estado:'no-show'}; }
      return c;
    });
    save(K.CITAS,citas); renderCitas(); alert('Marcado como No Show (si coincidía).');
  }
  function renderCitas(filter=true){
    const tb=byId('tblCitas').querySelector('tbody');
    const emps=load(K.EMP,[]);
    const empName = id => (emps.find(e=>e.id===id)||{}).nombre||'—';
    let citas=load(K.CITAS,[]);
    if(filter){
      const fFecha=byId('f_fecha').value;
      const fEmp=byId('f_emp').value;
      if(fFecha) citas=citas.filter(c=>c.fecha===fFecha);
      if(fEmp) citas=citas.filter(c=>c.emp===fEmp);
    }
    citas.sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
    tb.innerHTML = citas.map(c=>`
      <tr class="tr">
        <td>${c.fecha}</td>
        <td>${c.hora}</td>
        <td>${c.nombre}</td>
        <td>${empName(c.emp)}</td>
        <td>${c.srv||''}</td>
        <td>${c.tel}</td>
        <td>${c.estado}</td>
        <td class="no-print">
          <button class="btn-ghost" onclick="citaWhatsApp('${c.id}')">WA</button>
          <button class="btn-ghost" onclick="citaEditar('${c.id}')">Editar</button>
          <button class="btn-danger" onclick="citaBorrar('${c.id}')">Borrar</button>
        </td>
      </tr>`).join('');
  }
  function citaEditar(id){
    const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
    byId('a_nombre').value=c.nombre;
    byId('a_tel').value=c.tel;
    byId('a_emp').value=c.emp;
    byId('a_srv').value=c.srv||'';
    byId('a_fecha').value=c.fecha;
    byId('a_hora').value=c.hora;
    byId('a_dur').value=c.dur||60;
    byId('a_notas').value=c.notas||'';
  }
  function citaBorrar(id){
    save(K.CITAS, load(K.CITAS,[]).filter(x=>x.id!==id));
    renderCitas();
  }
  function citaWhatsApp(id){
    const cfg=load(K.CFG,{});
    const c=load(K.CITAS,[]).find(x=>x.id===id); if(!c) return;
    const emps=load(K.EMP,[]); const empName=(emps.find(e=>e.id===c.emp)||{}).nombre||'';
    const fechaTxt=new Date(c.fecha+'T'+(c.hora||'00:00')).toLocaleString('es-PR');
    const msg = encodeURIComponent(
      `Hola ${c.nombre}, confirmación de su cita:\n`+
      `🗓 ${fechaTxt}\n👤 Técnica: ${empName}\n💈 Servicio: ${c.srv||'-'}\n`+
      `${c.notas? '📝 Notas: '+c.notas+'\n':''}`+
      `${cfg.maps? '📍 Ubicación: '+cfg.maps+'\n':''}`+
      `Responda este mensaje para confirmar. ¡Gracias!`
    );
    const phone = (c.tel || cfg.waPhone || '').replace(/\D/g,'');
    window.open(`https://wa.me/${phone}?text=${msg}`,'_blank');
  }

  /* ============================================================
    FACTURACIÓN (líneas, totales, exportar, WhatsApp)
    ============================================================= */
  function nextFacturaNumber(){
    let n=load(K.COUNTER_F,1001); save(K.COUNTER_F, n+1); return n;
  }
  function lineaTpl(id,data={}){
    return `
    <div class="row cols-4 tr" style="padding:.6rem; margin:.4rem 0">
      <div><label>Descripción</label><input data-id="${id}" data-k="desc" class="input" placeholder="Servicio o producto" value="${data.desc||''}"></div>
      <div><label>Cant.</label><input data-id="${id}" data-k="cant" type="number" min="1" step="1" class="input" value="${data.cant||1}"></div>
      <div><label>Precio</label><input data-id="${id}" data-k="precio" type="number" step=".01" class="input" value="${data.precio||0}"></div>
      <div style="display:flex; align-items:flex-end; gap:.5rem">
        <input data-id="${id}" data-k="total" class="input" disabled value="${fmtMoney((data.cant||1)*(data.precio||0))}">
        <button class="btn-danger" onclick="lineaDel('${id}')">X</button>
      </div>
    </div>`;
  }
  function recalcFactura(){
    const rows=[...$$('#lineas [data-k="cant"]')].map(el=>{
      const id=el.dataset.id;
      const cant=+el.value||0;
      const precio=+byId(`lineas`).querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
      const tot=cant*precio;
      byId('lineas').querySelector(`[data-id="${id}"][data-k="total"]`).value=fmtMoney(tot);
      return tot;
    });
    const sub = rows.reduce((a,b)=>a+b,0);
    const ivuPct = +byId('f_ivu').value || 0; // ✅ IVU por defecto 0
    const ivu = sub*(ivuPct/100);
    const tot = sub+ivu;
    byId('f_sub').value=fmtMoney(sub);
    byId('f_tax').value=fmtMoney(ivu);
    byId('f_total').value=fmtMoney(tot);
    byId('ath_monto').value=fmtMoney(tot);
  }
  function lineaAdd(data={}){
    const id=uuid();
    byId('lineas').insertAdjacentHTML('beforeend', lineaTpl(id,data));
    ['cant','precio'].forEach(k=>{
      byId('lineas').querySelector(`[data-id="${id}"][data-k="${k}"]`).addEventListener('input', recalcFactura);
    });
    recalcFactura();
  }
  function lineaDel(id){
    const node=[...byId('lineas').children].find(div=>div.querySelector(`[data-id="${id}"]`));
    if(node) node.remove(); recalcFactura();
  }

  // ✅ Al crear nueva factura, NO se asigna número aún. IVU se fuerza a 0 por defecto.
  function facturaNueva(){
    byId('f_num').value = ''; // se asignará al guardar si es nueva
    byId('f_cli').value='';
    byId('f_tel').value='';
    const emps=load(K.EMP,[]);
    const firstActivo = emps.find(e => (e.activo === undefined ? true : +e.activo === 1));
    if(byId('ff_emp')) byId('ff_emp').value = (firstActivo||{}).id || '';
    byId('f_fecha').value = todayISO();
    byId('f_propina').value = 0;
    byId('f_pago').value='ATH Móvil';
    byId('f_ivu').value = 0; // ✅ IVU 0 por defecto
    byId('lineas').innerHTML='';
    recalcFactura();
  }

  // ✅ Al guardar: fecha se actualiza a hoy; asigna # si es nueva y lo refleja en el input
  function facturaGuardar(){
    let num   = byId('f_num').value.trim();

    const cli   = byId('f_cli').value.trim();
    const tel   = byId('f_tel').value.trim();
    const emp   = byId('ff_emp').value;

    // Fecha se ajusta automáticamente al guardar
    const fecha = todayISO();
    if(byId('f_fecha')) byId('f_fecha').value = fecha;

    const pago  = byId('f_pago').value;
    const ivu   = +(byId('f_ivu').value||0);
    const prop  = +(byId('f_propina').value||0) || 0;

    const items = [...$$('#lineas [data-k="desc"]')].map(el=>{
      const id=el.dataset.id;
      const cant  = +byId('lineas').querySelector(`[data-id="${id}"][data-k="cant"]`).value||0;
      const precio= +byId('lineas').querySelector(`[data-id="${id}"][data-k="precio"]`).value||0;
      return {desc:el.value, cant, precio};
    });
    if(!cli || items.length===0) return alert('Cliente y al menos una línea.');

    const sub=items.reduce((a,i)=>a+i.cant*i.precio,0);
    const tax=sub*(ivu/100);
    const tot=sub+tax; // Propina aparte

    let facts=load(K.FACTS,[]);
    let exists=facts.find(x=>String(x.num)===String(num));

    // Si no existe (nueva), asigna número de factura al guardar
    if(!exists){
      num = nextFacturaNumber();
      byId('f_num').value = num; // refleja el nuevo número en UI
    }

    const data={
      id:exists?.id||uuid(), num, cli, tel, emp, fecha, pago, ivu,
      propina: prop, notas: prop, // compatibilidad hacia atrás
      items, sub, tax, tot
    };

    if(exists){ facts = facts.map(x=> String(x.num)===String(num) ? data : x); }
    else { facts.push(data); }

    save(K.FACTS,facts);
    renderFacturas();
    alert('Factura guardada.');
  }

  function renderFacturas(){
    const tb=byId('tblFacturas').querySelector('tbody');
    let facts=load(K.FACTS,[]);
    const d=byId('h_desde').value, h=byId('h_hasta').value, e=byId('h_emp').value;
    if(d) facts=facts.filter(f=>f.fecha>=d);
    if(h) facts=facts.filter(f=>f.fecha<=h);
    if(e) facts=facts.filter(f=>f.emp===e);
    facts.sort((a,b)=> (b.fecha+a.num).localeCompare(a.fecha+b.num));
    const emps=load(K.EMP,[]); const empName=id=>(emps.find(x=>x.id===id)||{}).nombre||'';
    tb.innerHTML=facts.map(f=>`
      <tr class="tr">
        <td>${f.num}</td><td>${f.fecha}</td><td>${f.cli}</td><td>${empName(f.emp)}</td>
        <td>${f.pago}</td><td>${fmtMoney(f.tot)}</td>
        <td class="no-print">
          <button class="btn-ghost" onclick="factImprimir(${f.num})">PDF</button>
          <button class="btn-ghost" onclick="factCSV(${f.num})">CSV</button>
          <button class="btn-ghost" onclick="factWA(${f.num})">WA</button>
          <button class="btn-danger" onclick="factDel(${f.num})">X</button>
        </td>
      </tr>`).join('');
  }
  function factData(num){ return load(K.FACTS,[]).find(f=>String(f.num)===String(num)); }
  function factDel(num){ save(K.FACTS, load(K.FACTS,[]).filter(f=>String(f.num)!==String(num))); renderFacturas(); }
  function factWA(num){
    const cfg = load(K.CFG,{});
    const f = factData(num);
    if(!f) return;
    const emps = load(K.EMP,[]);
    const emp  = emps.find(e => e.id === f.emp) || {};
    const phone = (emp.tel || cfg.waPhone || '').replace(/\D/g,'');
    const prop = (typeof f.propina === 'number' ? f.propina : +(f.notas||0)) || 0;

    const msg = encodeURIComponent(
      `${cfg.waFacto || 'Gracias por su visita. Detalle:'}\n`+
      `Factura #${f.num}\n`+
      `Fecha: ${f.fecha}\n`+
      `Técnica: ${emp.nombre || ''}\n`+
      `Total: ${fmtMoney(f.tot)}\n`+
      (prop>0 ? `Propina: ${fmtMoney(prop)}\n` : '')+
      (cfg.maps ? `Ubicación: ${cfg.maps}\n` : '')+
      `Detalle:\n` + f.items.map(i =>
        `• ${i.desc} x${i.cant} = ${fmtMoney(i.cant*i.precio)}`
      ).join('\n')
    );

    if(phone){
      window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
    } else {
      alert("No se encontró número de teléfono para la técnica.");
    }
  }
  </script>
